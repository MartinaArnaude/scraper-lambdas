name: Create Lambda Layer

on:
  workflow_dispatch:  # Solo ejecuciÃ³n manual
  push:
    branches:
      - main
    paths:
      - 'requirements_lambda.txt'

jobs:
  create-layer:
    runs-on: ubuntu-latest  # Linux - perfecto para crear binarios Linux
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Create Lambda Layer
        run: |
          echo "ðŸ“¦ Creando Lambda Layer con binarios Linux..."
          
          # Crear estructura
          mkdir -p lambda-layer/python
          cd lambda-layer/python
          
          # Instalar dependencias (en Linux, los binarios serÃ¡n para Linux)
          pip install -r ../../requirements_lambda.txt -t . --no-cache-dir
          
          # Verificar pydantic-core
          echo ""
          echo "ðŸ” Verificando pydantic-core..."
          if [ -f "pydantic_core/_pydantic_core*.so" ] || find pydantic_core -name "_pydantic_core*.so" | head -1 | grep -q .; then
            echo "âœ… Binario de pydantic-core encontrado"
            find pydantic_core -name "_pydantic_core*.so" | head -3
          else
            echo "âš ï¸  No se encontrÃ³ binario de pydantic-core"
          fi
          
          cd ../..
          
          # LIMPIEZA CRÃTICA: Eliminar archivos innecesarios para reducir tamaÃ±o
          echo ""
          echo "ðŸ§¹ Limpiando archivos innecesarios..."
          cd lambda-layer/python
          
          # Eliminar archivos compilados (.pyc)
          find . -type f -name "*.pyc" -delete
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          
          # Eliminar metadatos y documentaciÃ³n (.dist-info, .egg-info)
          find . -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
          
          # Eliminar carpetas de tests
          find . -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "test" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "__tests__" -exec rm -rf {} + 2>/dev/null || true
          
          # Eliminar documentaciÃ³n
          find . -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "doc" -exec rm -rf {} + 2>/dev/null || true
          
          # Eliminar archivos de texto innecesarios
          find . -type f -name "*.txt" ! -name "__init__.py" -delete 2>/dev/null || true
          find . -type f -name "*.md" -delete 2>/dev/null || true
          find . -type f -name "*.rst" -delete 2>/dev/null || true
          find . -type f -name "LICENSE*" -delete 2>/dev/null || true
          find . -type f -name "COPYING*" -delete 2>/dev/null || true
          
          # Eliminar herramientas de instalaciÃ³n (no necesarias en runtime)
          rm -rf ./pip 2>/dev/null || true
          rm -rf ./setuptools 2>/dev/null || true
          rm -rf ./wheel 2>/dev/null || true
          rm -rf ./pkg_resources 2>/dev/null || true
          
          # Eliminar binarios innecesarios (mantener solo los .so necesarios)
          find . -type f -name "*.exe" -delete 2>/dev/null || true
          
          # Eliminar archivos de ejemplo
          find . -type d -name "examples" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "example" -exec rm -rf {} + 2>/dev/null || true
          
          cd ../..
          
          # Verificar tamaÃ±o despuÃ©s de limpieza
          echo ""
          echo "ðŸ“Š Verificando tamaÃ±o despuÃ©s de limpieza..."
          DU_SIZE=$(du -sb lambda-layer/python | cut -f1)
          DU_SIZE_MB=$((DU_SIZE / 1024 / 1024))
          echo "   TamaÃ±o descomprimido: ${DU_SIZE_MB} MB (lÃ­mite: 250 MB)"
          
          if [ $DU_SIZE_MB -gt 250 ]; then
            echo "âš ï¸  ADVERTENCIA: AÃºn es mayor a 250MB despuÃ©s de limpieza"
            echo "   Considera eliminar mÃ¡s dependencias o dividir en mÃºltiples layers"
          else
            echo "âœ… TamaÃ±o OK despuÃ©s de limpieza"
          fi
          
          # Crear ZIP
          echo ""
          echo "ðŸ“¦ Creando archivo zip..."
          cd lambda-layer
          zip -r layer.zip python/ -q
          cd ..
          
          # Verificar tamaÃ±o
          ZIP_SIZE=$(du -h lambda-layer/layer.zip | cut -f1)
          ZIP_SIZE_BYTES=$(stat -c%s lambda-layer/layer.zip)
          ZIP_SIZE_MB=$((ZIP_SIZE_BYTES / 1024 / 1024))
          
          echo ""
          echo "âœ… Layer creado: lambda-layer/layer.zip"
          echo "ðŸ“¦ TamaÃ±o: $ZIP_SIZE ($ZIP_SIZE_MB MB)"
      
      - name: Upload Layer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-layer
          path: lambda-layer/layer.zip
          retention-days: 7
      
      - name: Summary
        run: |
          echo "## âœ… Layer Creado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "El layer estÃ¡ disponible como artifact." >> $GITHUB_STEP_SUMMARY
          echo "DescÃ¡rgalo desde la pestaÃ±a 'Artifacts' de este workflow." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PrÃ³ximo paso:** Sube el layer a AWS Lambda" >> $GITHUB_STEP_SUMMARY

