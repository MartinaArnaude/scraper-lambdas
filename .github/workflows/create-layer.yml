name: Create Lambda Layer

on:
  workflow_dispatch:  # Solo ejecuci√≥n manual
  push:
    branches:
      - main
    paths:
      - 'requirements_lambda.txt'

jobs:
  create-layer:
    runs-on: ubuntu-latest  # Linux - perfecto para crear binarios Linux
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Create Lambda Layer
        run: |
          echo "üì¶ Creando Lambda Layer con binarios Linux..."
          
          # Crear estructura
          mkdir -p lambda-layer/python
          cd lambda-layer/python
          
          # Instalar dependencias (en Linux, los binarios ser√°n para Linux)
          pip install -r ../../requirements_lambda.txt -t . --no-cache-dir
          
          # Verificar pydantic-core
          echo ""
          echo "üîç Verificando pydantic-core..."
          if [ -f "pydantic_core/_pydantic_core*.so" ] || find pydantic_core -name "_pydantic_core*.so" | head -1 | grep -q .; then
            echo "‚úÖ Binario de pydantic-core encontrado"
            find pydantic_core -name "_pydantic_core*.so" | head -3
          else
            echo "‚ö†Ô∏è  No se encontr√≥ binario de pydantic-core"
          fi
          
          cd ../..
          
          # LIMPIEZA AGRESIVA: Eliminar TODO lo innecesario
          echo ""
          echo "üßπ Limpieza agresiva de archivos innecesarios..."
          cd lambda-layer/python
          
          # Eliminar archivos compilados
          find . -type f -name "*.pyc" -delete
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.pyo" -delete
          
          # Eliminar TODOS los metadatos y documentaci√≥n
          find . -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "*.egg" -exec rm -rf {} + 2>/dev/null || true
          
          # Eliminar TODAS las carpetas de tests
          find . -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "test" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "__tests__" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "testing" -exec rm -rf {} + 2>/dev/null || true
          
          # Eliminar TODA la documentaci√≥n
          find . -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "doc" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.md" -delete 2>/dev/null || true
          find . -type f -name "*.rst" -delete 2>/dev/null || true
          find . -type f -name "*.txt" ! -path "*/site-packages/*" -delete 2>/dev/null || true
          find . -type f -name "LICENSE*" -delete 2>/dev/null || true
          find . -type f -name "COPYING*" -delete 2>/dev/null || true
          find . -type f -name "CHANGELOG*" -delete 2>/dev/null || true
          find . -type f -name "README*" -delete 2>/dev/null || true
          
          # Eliminar herramientas de instalaci√≥n
          rm -rf ./pip 2>/dev/null || true
          rm -rf ./setuptools 2>/dev/null || true
          rm -rf ./wheel 2>/dev/null || true
          rm -rf ./pkg_resources 2>/dev/null || true
          rm -rf ./distutils 2>/dev/null || true
          
          # Eliminar binarios innecesarios
          find . -type f -name "*.exe" -delete 2>/dev/null || true
          find . -type f -name "*.bat" -delete 2>/dev/null || true
          
          # Eliminar ejemplos y demos
          find . -type d -name "examples" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "example" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "demos" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "demo" -exec rm -rf {} + 2>/dev/null || true
          
          # Eliminar archivos de configuraci√≥n innecesarios
          find . -type f -name "setup.py" -delete 2>/dev/null || true
          find . -type f -name "setup.cfg" -delete 2>/dev/null || true
          find . -type f -name "pyproject.toml" -delete 2>/dev/null || true
          find . -type f -name "MANIFEST.in" -delete 2>/dev/null || true
          
          # Limpieza espec√≠fica de crawl4ai (si es muy pesado)
          if [ -d "crawl4ai" ]; then
            echo "   Limpiando crawl4ai espec√≠ficamente..."
            find ./crawl4ai -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
            find ./crawl4ai -type f -name "*.md" -delete 2>/dev/null || true
            find ./crawl4ai -type f -name "*.txt" -delete 2>/dev/null || true
          fi
          
          # Limpieza espec√≠fica de pydantic (mantener solo lo esencial)
          if [ -d "pydantic" ]; then
            echo "   Limpiando pydantic espec√≠ficamente..."
            find ./pydantic -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
            find ./pydantic -type f -name "*.md" -delete 2>/dev/null || true
          fi
          
          # Eliminar archivos de tipo innecesarios
          find . -type f -name "*.html" -delete 2>/dev/null || true
          find . -type f -name "*.css" -delete 2>/dev/null || true
          find . -type f -name "*.js" -delete 2>/dev/null || true
          
          # Eliminar archivos vac√≠os y directorios vac√≠os
          find . -type d -empty -delete 2>/dev/null || true
          
          cd ../..
          
          # Verificar tama√±o despu√©s de limpieza
          echo ""
          echo "üìä Verificando tama√±o despu√©s de limpieza..."
          DU_SIZE=$(du -sb lambda-layer/python | cut -f1)
          DU_SIZE_MB=$((DU_SIZE / 1024 / 1024))
          echo "   Tama√±o descomprimido: ${DU_SIZE_MB} MB (l√≠mite: 250 MB)"
          
          if [ $DU_SIZE_MB -gt 250 ]; then
            echo "‚ö†Ô∏è  ADVERTENCIA: A√∫n es mayor a 250MB despu√©s de limpieza ($DU_SIZE_MB MB)"
            echo "   Analizando qu√© ocupa m√°s espacio..."
            du -sh */ 2>/dev/null | sort -rh | head -10
            echo ""
            echo "   Opciones:"
            echo "   1. Eliminar crawl4ai y usar solo requests + beautifulsoup4"
            echo "   2. Dividir en m√∫ltiples layers"
            echo "   3. Usar contenedores Docker en lugar de layers"
          else
            echo "‚úÖ Tama√±o OK despu√©s de limpieza ($DU_SIZE_MB MB < 250 MB)"
          fi
          
          # Crear ZIP
          echo ""
          echo "üì¶ Creando archivo zip..."
          cd lambda-layer
          zip -r layer.zip python/ -q
          cd ..
          
          # Verificar tama√±o
          ZIP_SIZE=$(du -h lambda-layer/layer.zip | cut -f1)
          ZIP_SIZE_BYTES=$(stat -c%s lambda-layer/layer.zip)
          ZIP_SIZE_MB=$((ZIP_SIZE_BYTES / 1024 / 1024))
          
          echo ""
          echo "‚úÖ Layer creado: lambda-layer/layer.zip"
          echo "üì¶ Tama√±o: $ZIP_SIZE ($ZIP_SIZE_MB MB)"
      
      - name: Upload Layer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-layer
          path: lambda-layer/layer.zip
          retention-days: 7
      
      - name: Summary
        run: |
          echo "## ‚úÖ Layer Creado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "El layer est√° disponible como artifact." >> $GITHUB_STEP_SUMMARY
          echo "Desc√°rgalo desde la pesta√±a 'Artifacts' de este workflow." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pr√≥ximo paso:** Sube el layer a AWS Lambda" >> $GITHUB_STEP_SUMMARY

